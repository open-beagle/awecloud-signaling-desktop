version: '3'

includes:
  common: ../Taskfile.yml

tasks:
  build:
    summary: Builds the application for Linux
    deps:
      - task: common:go:mod:tidy
      - task: common:build:frontend
        vars:
          BUILD_FLAGS:
            ref: .BUILD_FLAGS
          PRODUCTION:
            ref: .PRODUCTION
    cmds:
      - go build {{.BUILD_FLAGS}} -o {{.BIN_DIR}}/{{.APP_NAME}}
    vars:
      BUILD_FLAGS: '{{.BUILD_FLAGS | default (printf "-tags production -trimpath -buildvcs=false -ldflags=\"-w -s %s\"" .LDFLAGS)}}'
      LDFLAGS: '{{.LDFLAGS | default ""}}'
    env:
      GOOS: linux
      CGO_ENABLED: 1
      GOARCH: '{{.ARCH | default "amd64"}}'
      PRODUCTION: '{{.PRODUCTION | default "true"}}'

  run:
    cmds:
      - '{{.BIN_DIR}}/{{.APP_NAME}}'
